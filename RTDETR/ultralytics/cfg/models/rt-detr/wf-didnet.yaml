# Ultralytics YOLO ðŸš€, AGPL-3.0 license
# WF-DIDNet æœ€ç»ˆç‰ˆé…ç½® (Cascade Dehazing + PGM Interaction + RT-DETR)

# Parameters
nc: 80  # number of classes
scales: # model compound scaling constants
  l: [1.00, 1.00, 2048]

backbone:
  # [from, repeats, module, args]
  
  # =========================================================
  # ðŸ”¥ 0. åŽ»é›¾åˆ†æ”¯ (HighResMambaDehazeHead)
  # =========================================================
  # ä½œç”¨: æŽ¥æ”¶åŽŸå›¾ï¼Œè¾“å‡ºæ¸…æ™°å›¾ç»™ä¸‹ä¸€å±‚ï¼Œå¹¶ç¼“å­˜ç‰¹å¾ç»™ PGM ç”¨
  # args: [hidden_dim=128, depth=2] (éœ€ä¸Ž python ä»£ç ä¸€è‡´)
  - [-1, 1, HighResMambaDehazeHead, [128, 2]]  # Layer 0

  # =========================================================
  # ðŸš€ RT-DETR éª¨å¹²ç½‘ç»œ (æŽ¥æ”¶ Layer 0 çš„æ¸…æ™°å›¾è¾“å‡º)
  # =========================================================
  - [-1, 1, HGStem, [32, 48]]        # 1. Stemå±‚
  - [-1, 6, HGBlock, [48, 128, 3]]   # 2. Stage 1

  # --- P3 é˜¶æ®µ ---
  - [-1, 1, DWConv, [256, 3, 2]]     # 3. ä¸‹é‡‡æ · P3/8
  - [-1, 6, RepC3, [256]]            # 4. P3 ç‰¹å¾æå–
  - [-1, 1, SimAM, []]               # 5. SimAM æ³¨æ„åŠ›

  # =========================================================
  # ðŸ”¥ 6. ç‰©ç†å¼•å¯¼äº¤äº’æ¨¡å— (PGM)
  # =========================================================
  # ä½œç”¨: èžåˆ Layer 0 çš„åŽ»é›¾ç‰¹å¾ï¼Œæ¸…æ´— Layer 5 çš„æ£€æµ‹ç‰¹å¾
  # args: [det_dim=256, dehaze_dim=128] (éœ€åŒ¹é… P3 å’Œ åŽ»é›¾å¤´ç»´åº¦)
  - [-1, 1, PhysicalGuidanceModule, [64]] # 6. P3 è¾“å‡º (ç”¨äºŽHead)

  # --- P4 é˜¶æ®µ ---
  - [-1, 1, DWConv, [512, 3, 2]]     # 7. ä¸‹é‡‡æ · P4/16
  - [-1, 6, RepC3, [512]]            # 8. P4 ç‰¹å¾æå–
  - [-1, 1, SimAM, []]               # 9. P4 è¾“å‡º (ç”¨äºŽHead)

  # --- P5 é˜¶æ®µ ---
  - [-1, 1, DWConv, [1024, 3, 2]]    # 10. ä¸‹é‡‡æ · P5/32
  - [-1, 6, RepC3, [1024]]           # 11. P5 ç‰¹å¾æå–
  - [-1, 1, SimAM, []]               # 12. P5 è¾“å‡º (ç”¨äºŽHead)

head:
  # =========================================================
  # ðŸ—ï¸ RT-DETR æ··åˆç¼–ç å™¨ (Hybrid Encoder)
  # =========================================================
  # æ³¨æ„ï¼šè¿™é‡Œçš„ from ç´¢å¼•å¿…é¡»å¯¹åº”ä¸Šé¢çš„ P3, P4, P5
  # P3 = Layer 6 (PGMè¾“å‡º)
  # P4 = Layer 9 (SimAMè¾“å‡º)
  # P5 = Layer 12 (SimAMè¾“å‡º)
  
  # --- å¤„ç† P5 (Layer 12) ---
  - [-1, 1, Conv, [256, 1, 1, None, 1, 1, False]]  # 13. input_proj (P5)
  - [-1, 1, AIFI, [1024, 8]]                       # 14. Transformer å±‚
  - [-1, 1, Conv, [256, 1, 1]]                     # 15.

  # --- èžåˆ P4 (Layer 9) ---
  - [-1, 1, nn.Upsample, [None, 2, 'nearest']]     # 16. ä¸Šé‡‡æ ·
  - [9, 1, Conv, [256, 1, 1, None, 1, 1, False]]   # 17. input_proj (P4 from Layer 9)
  - [[-2, -1], 1, Concat, [1]]                     # 18.
  - [-1, 3, RepC3, [256]]                          # 19.
  - [-1, 1, Conv, [256, 1, 1]]                     # 20.

  # --- èžåˆ P3 (Layer 6) ---
  - [-1, 1, nn.Upsample, [None, 2, 'nearest']]     # 21. ä¸Šé‡‡æ ·
  - [6, 1, Conv, [256, 1, 1, None, 1, 1, False]]   # 22. input_proj (P3 from Layer 6)
  - [[-2, -1], 1, Concat, [1]]                     # 23.
  - [-1, 3, RepC3, [256]]                          # 24. (è¾“å‡ºç»™ Decoder)

  # --- ä¸‹é‡‡æ ·å›žåˆ° P4 ---
  - [-1, 1, DWConv, [256, 3, 2]]                   # 25.
  - [[-1, 20], 1, Concat, [1]]                     # 26. (Cat Layer 20)
  - [-1, 3, RepC3, [256]]                          # 27. (è¾“å‡ºç»™ Decoder)

  # --- ä¸‹é‡‡æ ·å›žåˆ° P5 ---
  - [-1, 1, DWConv, [256, 3, 2]]                   # 28.
  - [[-1, 15], 1, Concat, [1]]                     # 29. (Cat Layer 15)
  - [-1, 3, RepC3, [256]]                          # 30. (è¾“å‡ºç»™ Decoder)

  # =========================================================
  # ðŸŽ¯ RT-DETR æ£€æµ‹è§£ç å™¨
  # =========================================================
  # from: [P3(24), P4(27), P5(30)]
  - [[24, 27, 30], 1, RTDETRDecoder, [nc, 256, 300, 4, 8, 3]]  # 31. æ£€æµ‹è¾“å‡º
  
  
#   # Ultralytics YOLO ðŸš€, AGPL-3.0 license
# # RT-DETR-ResNet18 (ä¿®å¤ç‰ˆv2) - ä¿®æ­£äº† ResNetLayer å‚æ•°é¡ºåº

# nc: 5
# scales:
#   l: [1.00, 1.00, 1024]

# backbone:
#   # [from, repeats, module, args]
  
#   # 0. åŽ»é›¾å¤´ (64 ch è¾“å‡º)
#   - [-1, 1, HighResMambaDehazeHead, [64, 2]]

#   # 1. Stem (Conv)
#   - [0, 1, Conv, [64, 7, 2, 3]]
#   - [-1, 1, nn.MaxPool2d, [3, 2, 1]]

#   # 2. Stage 1 (64 ch)
#   # args ä¿®æ­£ä¸º: [out_channels, kernel=3, stride=1]
#   # æ³¨æ„ï¼šä¸åŒç‰ˆæœ¬çš„ ultralytics å¯èƒ½è§£æžé€»è¾‘ä¸åŒï¼Œé€šå¸¸æ˜¯ç”¨ standard Conv args
#   # è¿™é‡Œæˆ‘ä»¬æ”¹ç”¨æœ€ç¨³çš„ Conv å †å æˆ–è€… C2f (YOLOé£Žæ ¼) æ¥æ›¿ä»£ ResNetLayer ä»¥é¿å…å‚æ•°æ­§ä¹‰
#   # ä½†ä¸ºäº†ä¿æŒ ResNet é£Žæ ¼ï¼Œæˆ‘ä»¬å°è¯•ç”¨æ ‡å‡†çš„ ResNetBlock å®šä¹‰
#   # å‡è®¾ ResNetLayer æŽ¥æ”¶ [c1, c2, k, s]
  
#   - [-1, 2, ResNetLayer, [64, 3, 1]] # 3. 64->64

#   # 3. Stage 2 (128 ch)
#   - [-1, 2, ResNetLayer, [128, 3, 2]] # 4. 64->128, stride 2

#   # 4. PGM Fusion
#   - [[-1, 0], 1, PhysicalGuidanceModule, [128, 64]] # 5.

#   # 5. Stage 3 (256 ch)
#   - [-1, 2, ResNetLayer, [256, 3, 2]] # 6. 128->256, stride 2

#   # 6. Stage 4 (512 ch)
#   - [-1, 2, ResNetLayer, [512, 3, 2]] # 7. 256->512, stride 2

# head:
#   # Hybrid Encoder
#   - [-1, 1, Conv, [256, 1, 1, None, 1, 1, False]] # 8. P5 proj
#   - [-1, 1, AIFI, [1024, 8]] # 9.
#   - [-1, 1, Conv, [256, 1, 1]] # 10.

#   - [-1, 1, nn.Upsample, [None, 2, 'nearest']] # 11.
#   - [6, 1, Conv, [256, 1, 1, None, 1, 1, False]] # 12. P4 proj (input from layer 6)
#   - [[-2, -1], 1, Concat, [1]] # 13.
#   - [-1, 3, RepC3, [256, 0.5]] # 14.

#   - [-1, 1, Conv, [256, 1, 1]] # 15.
#   - [-1, 1, nn.Upsample, [None, 2, 'nearest']] # 16.
#   - [5, 1, Conv, [256, 1, 1, None, 1, 1, False]] # 17. P3 proj (input from PGM layer 5)
#   - [[-2, -1], 1, Concat, [1]] # 18.
#   - [-1, 3, RepC3, [256, 0.5]] # 19. P3 Output

#   # Downsample
#   - [-1, 1, Conv, [256, 3, 2]] # 20.
#   - [[-1, 15], 1, Concat, [1]] # 21.
#   - [-1, 3, RepC3, [256, 0.5]] # 22. P4 Output

#   - [-1, 1, Conv, [256, 3, 2]] # 23.
#   - [[-1, 10], 1, Concat, [1]] # 24.
#   - [-1, 3, RepC3, [256, 0.5]] # 25. P5 Output

#   # Decoder
#   - [[19, 22, 25], 1, RTDETRDecoder, [nc, 256, 300, 4, 8, 3]]

# Ultralytics YOLO ðŸš€, AGPL-3.0 license
# RT-DETR-l with Mamba Dehaze & PGM
# Based on custom config with iRMB

# Ultralytics YOLO ðŸš€, AGPL-3.0 license
# RT-DETR-ResNet18 with HighResMambaDehazeHead & PGM
# è½»é‡åŒ–ç‰ˆæœ¬ï¼šè§£å†³ OOM é—®é¢˜çš„ç»ˆæžæ–¹æ¡ˆ

# nc: 5  # ä½ çš„ç±»åˆ«æ•°
# scales:
#   l: [1.00, 1.00, 1024]

# backbone:
#   # [from, repeats, module, args]
  
#   # ==========================================
#   # 0. åŽ»é›¾å¤´ (HighResMambaDehazeHead)
#   # ==========================================
#   # Input: Image (3 ch)
#   # Output: (trans_map, recon_img, dehaze_feat=64ch)
#   # Mamba åœ¨ 64 é€šé“è¿è¡Œï¼Œé€Ÿåº¦å¿«ä¸”æ˜¾å­˜çœ
#   - [-1, 1, HighResMambaDehazeHead, [64, 2]]  

#   # ==========================================
#   # 1. ResNet18 Stem (è¾“å…¥æ˜¯ Layer 0 çš„ recon_img)
#   # ==========================================
#   - [0, 1, Conv, [64, 7, 2, 3]]  # 1. Conv 7x7
#   - [-1, 1, nn.MaxPool2d, [3, 2, 1]] # 2. MaxPool 3x3

#   # ==========================================
#   # 2. ResNet18 Stages (ä½¿ç”¨ BasicBlock)
#   # ==========================================
#   # args: [out_channels, stride, is_basic_block]
#   # ResNet18/34 ä½¿ç”¨ BasicBlock (True)
  
#   # Stage 1 (Layer 1) -> 64ch
#   - [-1, 2, ResNetLayer, [64, 1, True]] # 3. P2

#   # Stage 2 (Layer 2) -> 128ch
#   - [-1, 2, ResNetLayer, [128, 2, True]] # 4. P3 (128ch)

#   # ==========================================
#   # 3. PGM èžåˆæ¨¡å—
#   # ==========================================
#   # èžåˆ: Backbone P3 (128ch) + Dehaze Feat (64ch)
#   # è¾“å…¥ç´¢å¼•: [-1 (Layer 4), 0 (Layer 0)]
#   - [[-1, 0], 1, PhysicalGuidanceModule, [128, 64]] # 5. PGM Output (128ch)

#   # Stage 3 (Layer 3) -> 256ch
#   - [-1, 2, ResNetLayer, [256, 2, True]] # 6. P4

#   # Stage 4 (Layer 4) -> 512ch
#   - [-1, 2, ResNetLayer, [512, 2, True]] # 7. P5

# head:
#   # ==========================================
#   # 4. Hybrid Encoder (é’ˆå¯¹ ResNet18 é€šé“è°ƒæ•´)
#   # ==========================================
#   # è¾“å…¥: P3(128), P4(256), P5(512)
#   # æŠ•å½±ç›®æ ‡ç»´åº¦: 256 (hidden_dim)

#   # P5 å¤„ç†
#   - [-1, 1, Conv, [256, 1, 1, None, 1, 1, False]]  # 8. input_proj (512->256)
#   - [-1, 1, AIFI, [256, 8]] # 9. AIFI (Transformer)
#   - [-1, 1, Conv, [256, 1, 1]]   # 10.

#   # P4 èžåˆ (Upsample P5 + P4)
#   - [-1, 1, nn.Upsample, [None, 2, 'nearest']] # 11.
#   - [6, 1, Conv, [256, 1, 1, None, 1, 1, False]] # 12. P4 proj (256->256)
#   - [[-2, -1], 1, Concat, [1]] # 13.
#   - [-1, 3, RepC3, [256, 0.5]] # 14.

#   # P3 èžåˆ (Upsample P4 + P3)
#   - [-1, 1, Conv, [256, 1, 1]]   # 15.
#   - [-1, 1, nn.Upsample, [None, 2, 'nearest']] # 16.
#   - [5, 1, Conv, [256, 1, 1, None, 1, 1, False]] # 17. P3 proj (128->256) - æ³¨æ„æ¥æºæ˜¯ Layer 5 (PGM)
#   - [[-2, -1], 1, Concat, [1]] # 18.
#   - [-1, 3, RepC3, [256, 0.5]] # 19. Output P3

#   # ä¸‹é‡‡æ ·è·¯å¾„ P3 -> P4
#   - [-1, 1, Conv, [256, 3, 2]] # 20.
#   - [[-1, 15], 1, Concat, [1]] # 21.
#   - [-1, 3, RepC3, [256, 0.5]] # 22. Output P4

#   # ä¸‹é‡‡æ ·è·¯å¾„ P4 -> P5
#   - [-1, 1, Conv, [256, 3, 2]] # 23.
#   - [[-1, 10], 1, Concat, [1]] # 24.
#   - [-1, 3, RepC3, [256, 0.5]] # 25. Output P5

#   # ==========================================
#   # 5. Decoder (æ£€æµ‹å¤´)
#   # ==========================================
#   - [[19, 22, 25], 1, RTDETRDecoder, [nc, 256, 300, 4, 8, 3]]