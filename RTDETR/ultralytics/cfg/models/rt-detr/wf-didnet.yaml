# Ultralytics YOLO ğŸš€, AGPL-3.0 license
# WF-DIDNet æœ€ç»ˆç‰ˆé…ç½® (Cascade Dehazing + PGM Interaction + RT-DETR)

# Parameters
nc: 80  # number of classes
scales: # model compound scaling constants
  l: [1.00, 1.00, 2048]

backbone:
  # [from, repeats, module, args]
  
  # =========================================================
  # ğŸ”¥ 0. å»é›¾åˆ†æ”¯ (HighResMambaDehazeHead)
  # =========================================================
  # ä½œç”¨: æ¥æ”¶åŸå›¾ï¼Œè¾“å‡ºæ¸…æ™°å›¾ç»™ä¸‹ä¸€å±‚ï¼Œå¹¶ç¼“å­˜ç‰¹å¾ç»™ PGM ç”¨
  # args: [hidden_dim=128, depth=2] (éœ€ä¸ python ä»£ç ä¸€è‡´)
  - [-1, 1, HighResMambaDehazeHead, [128, 2]]  # Layer 0

  # =========================================================
  # ğŸš€ RT-DETR éª¨å¹²ç½‘ç»œ (æ¥æ”¶ Layer 0 çš„æ¸…æ™°å›¾è¾“å‡º)
  # =========================================================
  - [-1, 1, HGStem, [32, 48]]        # 1. Stemå±‚
  - [-1, 6, HGBlock, [48, 128, 3]]   # 2. Stage 1

  # --- P3 é˜¶æ®µ ---
  - [-1, 1, DWConv, [256, 3, 2]]     # 3. ä¸‹é‡‡æ · P3/8
  - [-1, 6, RepC3, [256]]            # 4. P3 ç‰¹å¾æå–
  - [-1, 1, SimAM, []]               # 5. SimAM æ³¨æ„åŠ›

  # =========================================================
  # ğŸ”¥ 6. ç‰©ç†å¼•å¯¼äº¤äº’æ¨¡å— (PGM)
  # =========================================================
  # ä½œç”¨: èåˆ Layer 0 çš„å»é›¾ç‰¹å¾ï¼Œæ¸…æ´— Layer 5 çš„æ£€æµ‹ç‰¹å¾
  # args: [det_dim=256, dehaze_dim=128] (éœ€åŒ¹é… P3 å’Œ å»é›¾å¤´ç»´åº¦)
  - [-1, 1, PhysicalGuidanceModule, [64]] # 6. P3 è¾“å‡º (ç”¨äºHead)

  # --- P4 é˜¶æ®µ ---
  - [-1, 1, DWConv, [512, 3, 2]]     # 7. ä¸‹é‡‡æ · P4/16
  - [-1, 6, RepC3, [512]]            # 8. P4 ç‰¹å¾æå–
  - [-1, 1, SimAM, []]               # 9. P4 è¾“å‡º (ç”¨äºHead)

  # --- P5 é˜¶æ®µ ---
  - [-1, 1, DWConv, [1024, 3, 2]]    # 10. ä¸‹é‡‡æ · P5/32
  - [-1, 6, RepC3, [1024]]           # 11. P5 ç‰¹å¾æå–
  - [-1, 1, SimAM, []]               # 12. P5 è¾“å‡º (ç”¨äºHead)

head:
  # =========================================================
  # ğŸ—ï¸ RT-DETR æ··åˆç¼–ç å™¨ (Hybrid Encoder)
  # =========================================================
  # æ³¨æ„ï¼šè¿™é‡Œçš„ from ç´¢å¼•å¿…é¡»å¯¹åº”ä¸Šé¢çš„ P3, P4, P5
  # P3 = Layer 6 (PGMè¾“å‡º)
  # P4 = Layer 9 (SimAMè¾“å‡º)
  # P5 = Layer 12 (SimAMè¾“å‡º)
  
  # --- å¤„ç† P5 (Layer 12) ---
  - [-1, 1, Conv, [256, 1, 1, None, 1, 1, False]]  # 13. input_proj (P5)
  - [-1, 1, AIFI, [1024, 8]]                       # 14. Transformer å±‚
  - [-1, 1, Conv, [256, 1, 1]]                     # 15.

  # --- èåˆ P4 (Layer 9) ---
  - [-1, 1, nn.Upsample, [None, 2, 'nearest']]     # 16. ä¸Šé‡‡æ ·
  - [9, 1, Conv, [256, 1, 1, None, 1, 1, False]]   # 17. input_proj (P4 from Layer 9)
  - [[-2, -1], 1, Concat, [1]]                     # 18.
  - [-1, 3, RepC3, [256]]                          # 19.
  - [-1, 1, Conv, [256, 1, 1]]                     # 20.

  # --- èåˆ P3 (Layer 6) ---
  - [-1, 1, nn.Upsample, [None, 2, 'nearest']]     # 21. ä¸Šé‡‡æ ·
  - [6, 1, Conv, [256, 1, 1, None, 1, 1, False]]   # 22. input_proj (P3 from Layer 6)
  - [[-2, -1], 1, Concat, [1]]                     # 23.
  - [-1, 3, RepC3, [256]]                          # 24. (è¾“å‡ºç»™ Decoder)

  # --- ä¸‹é‡‡æ ·å›åˆ° P4 ---
  - [-1, 1, DWConv, [256, 3, 2]]                   # 25.
  - [[-1, 20], 1, Concat, [1]]                     # 26. (Cat Layer 20)
  - [-1, 3, RepC3, [256]]                          # 27. (è¾“å‡ºç»™ Decoder)

  # --- ä¸‹é‡‡æ ·å›åˆ° P5 ---
  - [-1, 1, DWConv, [256, 3, 2]]                   # 28.
  - [[-1, 15], 1, Concat, [1]]                     # 29. (Cat Layer 15)
  - [-1, 3, RepC3, [256]]                          # 30. (è¾“å‡ºç»™ Decoder)

  # =========================================================
  # ğŸ¯ RT-DETR æ£€æµ‹è§£ç å™¨
  # =========================================================
  # from: [P3(24), P4(27), P5(30)]
  - [[24, 27, 30], 1, RTDETRDecoder, [nc, 256, 300, 4, 8, 3]]  # 31. æ£€æµ‹è¾“å‡º